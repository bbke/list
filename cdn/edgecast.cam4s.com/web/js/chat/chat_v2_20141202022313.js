var TRIE_TERMINAL_ENTRY="zzzzzzzzzzzzz";var isanonymous=false;var loginRoomSuccess=false;var needRoomPsd=false;var canChat=false;var emoticons={":\\)":"smile.gif",":D":"smiley.gif",":p":"silly.gif",":w":"confused.gif",";\\)":"wink.gif",":l":"smoker.gif",":\\?":"ponder.gif",":a":"ogre.gif",":\\(":"depressed.gif",":g":"grin.gif","8\\)":"cool.gif",":e":"evil.gif",":x":"heart.gif",":r":"surprised.gif"};var Chat=(function(){var ac=false;var o=null;var X;var ad="";var K=0;var w="";var I="";var N="";var v="";var S=false;var k=0;var t=0;var q={};var F,m,G,g,a;var L;var n=false;var h=false;function C(ae,ai,ah,ag){n=ag;w=ah;I=ai;N=ae;v=cam4WebChatHost;console.log("Firebase init room");if(ai==""||ah==""){S=true;cam4WebChatHost+="requestAccess?roomname="+ae;}else{cam4WebChatHost+="requestAccess?roomname="+ae+"&accessHash="+ah+"&username="+ai;}var af=$j.ajax({url:cam4WebChatHost,context:document.body});Trie.mapChars();af.done(function(ak){if(ak.status=="bannedForRoom"){B();return;}V();ad=ak.token;if(S){var aj=ak.guestNodeName;isanonymous=true;z(ad,ae,ai,aj);}else{loginRoomSuccess=true;canChat=true;z(ad,ae,ai,"");}});}function z(af,ae,ah,ag){F=new Firebase(cam4FirebaseHost+".info/connected");baseConnection=new Firebase(cam4FirebaseHost+"chatRooms");baseConnection.auth(af,function(ai){m=baseConnection.child(ae+"/roster/webUsers/"+ah);G=baseConnection.child(ae+"/roomState");g=baseConnection.child(ae+"/roster");a=baseConnection.child(ae+"/chatMessages");L=baseConnection.child(ae+"/roster/guestWebUsers/"+ag);if(ag!=""){E(ae,ag);}if(ah!=""){W(ae,ah);}U(ae);});}function s(ag){ag=ag.concat(" ");for(var ae in emoticons){if(emoticons.hasOwnProperty(ae)){var af=new RegExp(ae+"(?=[: ;])","ig");ag=ag.replace(af,'<img alt="'+Cam4Chat.emoticonsImgAlt+'" src="'+WEB_CDN+"images/chat/emoticons/"+emoticons[ae]+'">');}}return ag;}function E(ae,af){F.on("value",function(ag){if(ag.val()===true){L.set({online:true});L.onDisconnect().set(null);}});}function W(ae,af){F.on("value",function(ag){if(ag.val()===true){m.child("presence").set({online:true});m.child("presence").onDisconnect().set({online:false});}});}function V(){$j("#msgbox").focus();for(var ae in emoticons){if(emoticons.hasOwnProperty(ae)){$j("#emoticonList").append('<img alt="'+Cam4Chat.emoticonsImgAlt+'" src="'+WEB_CDN+"images/chat/emoticons/"+emoticons[ae]+'" onclick="Chat.insertEmoticon(\''+ae+"')\">");}}$j("#emoticonBtn").click(function(af){af.stopPropagation();R("toggle");});}function R(ae){if(ae=="show"){$j("#emoticons").show();}if(ae=="hide"){$j("#emoticons").hide();$j("#msgbox").focus();}if(ae=="toggle"){$j("#emoticons").toggle();$j("#msgbox").focus();}}function y(ae){$j("#msgbox").val($j("#msgbox").val()+ae+" ");R("hide");}function Q(ae){username=ae.name();info=ae.child("userInfo").val();q[username]={access_level:info.access_level,imageCDN:info.imageCDN,isBroadcasting:info.isBroadcasting,isRoomModerator:info.isRoomModerator,isVoiced:info.isVoiced,isSilenced:info.isSilenced};if(info.access_level!="admin"){if(info.access_level!="general"){username="g"+username;}else{username="n"+username;}if(ae.child("presence").val().online){l(username,info);}else{x(username);}}}function j(af,ae){af.forEach(function(ag){if(ag.child("presence").val().online){username=ag.name();info=ag.child("userInfo").val();q[username]={access_level:info.access_level,imageCDN:info.imageCDN,isBroadcasting:info.isBroadcasting,isRoomModerator:info.isRoomModerator,isVoiced:info.isVoiced,isSilenced:info.isSilenced};if(info.access_level!="admin"){if(username==ae){username="a"+username;}else{if(info.access_level!="general"){username="g"+username;}else{username="n"+username;}}l(username,info);}}});}function b(ae){m.child("userInfo").on("child_added",function(af,ag){if(af.name()=="kicked"&&af.val()==true){if(!h){$j("#containerFirebase").html("");$j("#errorKicked").detach().appendTo("#containerFirebase").show();m.child("userInfo").off();h=true;}}});m.child("userInfo").on("child_changed",function(af,ag){if(af.name()=="isBanned"&&af.val()==true){if(!h){B();m.child("presence").set({online:false});baseConnection.unauth();h=true;}}});G.on("value",function(af,ag){guestCount=af.val().guestCount;webGuestCount=af.val().webGuestCount;t=guestCount+webGuestCount;P();});}function B(){$j("#containerFirebase").html("");$j("#errorBanned").detach().appendTo("#containerFirebase").show();m.child("userInfo").off();}function U(ae){Trie.add(TRIE_TERMINAL_ENTRY);g.child("webUsers").on("child_changed",function(af,ag){Q(af);});g.child("wowzaUsers").on("child_changed",function(af,ag){Q(af);});g.once("value",function(af,ag){j(af.child("webUsers"),ae);j(af.child("wowzaUsers"),ae);c(ae);});}function c(ae){var af=true;a.limit(3).on("child_added",function(ag,aj){var ai=ag.val();var ah=ai.message;var ak=ai.username;if(!q[ak].isSilenced||Cam4User.userName==ak){if(n){Z(ah,ak,ae);}else{d(ah,ak,ae);}}b(ae);});}function f(){var ae=$j("#msgbox").val();$j("#msgbox").val("");if(q[Cam4User.userName].isSilenced){if(n){if(msg==""){return;}else{Z(ae,Cam4User.userName,"");}}else{if(msg==""){J("noMessage","");}else{d(ae,Cam4User.userName,"");}}}else{$j.ajax({type:"POST",encoding:"UTF-8",data:{username:I,accessHash:w,roomname:N,message:ae},url:v+"writeMessage",success:function(ag){statusMessage=ag.status;if(statusMessage!="success"){var af=0;if(ag.maxSlots!=undefined){af=ag.maxSlots;}J(statusMessage,af);}}});}}function J(af,ae){if(Cam4ChatErrors[af]!=undefined){$j("#textErrorMessage").text(Cam4ChatErrors[af].replace("{0}",ae));}else{$j("#textErrorMessage").text(af);}$j("#errorMessage").show();}function u(ae){ae=ae.replace(/\</g,"&lt;");ae=ae.replace(/\>/g,"&gt;");return ae;}function d(ah,ai,af){var ae="";var ag="basic odd";if(k%2){ag="basic even";}if(q[ai]!=undefined&&q[ai]!=null){ae=q[ai].imageCDN;if(q[ai].access_level!="general"){ag="gold odd";if(k%2){ag="gold even";}}if(af==ai){ag="broadcaster";}switch(q[ai].access_level){case"admin":ag="admin";ai="admin";ae=WEB_CDN+"/images/avatar_cam4admin.gif";break;case"moderator":ag="admin";ai="admin";ae=WEB_CDN+"/images/avatar_cam4admin.gif";break;case"coach":ag="coach";ai="coach";ae=WEB_CDN+"/images/avatar_cam4coach.gif";break;}}k++;return H(u(ah),ai,ag,ae);}function H(aj,ae,ai,af){var ah="";aj=s(aj);ah+="<div class='chat "+ai+"'>";ah+="<img width='40' class='chatAvatar' src='"+af+"'/>";ah+="<div class='messageLine'><span class='nickName'><strong>"+ae+"</strong></span><br>";ah+="<span>"+aj+"</span></div>";var ag=document.getElementById("groupchatChat");ah+='<div style="clear:both"></div></div>';ag.innerHTML+=ah;ag.scrollTop=ag.scrollHeight;return ag;}function Z(af,ag,ae){userClass="userBasic";if(q[ag]!=undefined&&q[ag]!=null){if(q[ag].access_level!="general"){userClass="userGold";}if(ae==ag){userClass="userBroadcaster";}switch(q[ag].access_level){case"admin":userClass="userAdmin";ag="admin";break;case"moderator":userClass="userModerator";ag="admin";break;case"coach":userClass="userCoatch";ag="coach";break;}}return Y(u(af),ag,userClass);}var D=0;function Y(ai,ae,ah){var ag="";ag+='<div class="chat">';ag+='<span class="msgnick '+ah+'">&lt;'+htmlEnc(ae)+"&gt;</span>&nbsp;";ag+=ai;ag+="</div>";var af=document.getElementById("groupchatChat");af.innerHTML=af.innerHTML.concat(ag);af.scrollTop=af.scrollHeight;}function l(af,ae){if(ae.isVoiced||ae.access_level!="general"||af.charAt(0)=="a"){nextFoundUser=Trie.add(af);if(!n){O(af.substr(1),nextFoundUser.substr(1),ae);}}}function x(ae){Trie.deleteUsername(ae);r(ae.substr(1));}function O(aj,ah,ai){var ae="";var af="";var ag="color:#FFFFFF";if(ai.access_level!="general"||ai.isBroadcasting){ag="color:#FBFF00";}if(ai.isBroadcasting){af="broadcasting";ag="color:#FFFFFF";}ae+='<div class="divUsername" id="'+aj+'" >';ae+='<img src="'+ai.imageCDN+'" width="30" height="25" style="float:left; margin:7px"/>';ae+='<p class="name" style="padding-top:12px;padding-left:5px;float:left;'+ag+'">'+aj+" "+af+"</p>";ae+="</div>";$jq("#"+ah).before(ae);K++;P();}function r(ae){$jq("#"+ae).remove();K--;P();}function P(){$jq("#totalChatting").text(K);$jq("#totalUsers").text(K+t);}function p(){$j("#msgbox").val("");var af=$jq(window).height();var ae=$jq(window).width();$jq("#loginAlert").css("left",ae/2-$jq("#loginAlert").width()/2);$jq("#loginAlert").show();$jq("usernameAlertBox").focus();}function e(){$jq("#loginAlert").hide();}function aa(){if(!ac){o.src=rideoSource;o.play();ac=true;}}function M(){if(ac){o.pause();o.src=null;ac=false;}}function T(){$j("#errorMessage").hide();}function ab(){$j("#tabs li a:not(:first)").addClass("inactive");$j(".container").hide();$j(".container:first").show();$j("#tabs li a").click(function(){var ae=$j(this).attr("id");if($j(this).hasClass("inactive")){$j("#tabs li a").addClass("inactive");$j(this).removeClass("inactive");$j(".container").hide();$j("#"+ae+"C").show();if($j(this).attr("id")!="tab1"){$j(".fakechatbutton").hide();}else{$j(".fakechatbutton").show();}}});}var A={init:C,showLoginAlert:p,hideLoginAlert:e,handleMessage:d,add:l,sendMessage:f,closeErrorBox:T,toggleChatMenu:ab,globalUsers:q,insertEmoticon:y};return A;})();var Trie=(function(){var j;var a="";var e="0123456789abcdefghijklmnopqrstuvwxyz_";var g=e.length;var k=[];var h=[];var d={link:new Array(g),end:0,children:0};function q(){for(i=0;i<e.length;i++){k[i]=e.charAt(i);h[e.charCodeAt(i)]=i;}}function p(u){var r=d;var s;var t;parentNode=d;a="";for(i=0;i<u.length;i++){j=h[u.charCodeAt(i)];if(r.end==0&&r.link[j]==undefined){if(i<u.length-1){newNodeArray=new Array(g);end=0;}else{newNodeArray=undefined;end=1;}s={link:newNodeArray,end:end,parentNode:parentNode,children:0};r.link[j]=s;r.children++;r=s;}else{r=r.link[j];if(i==u.length-1){r.end=1;}}t=r;parentNode=r;}a=b(u,t);return a;}function b(u,t){var r;a="";findedNode=n(t);if(findedNode){a=u+a;}if(a==""){var s=u.length-1;parentNode=t;while(parentNode.parentNode!=undefined){parentNode=parentNode.parentNode;r=l(parentNode,h[u.charCodeAt(s)]);a=u.substr(0,s)+a;s--;if(r>-1){findedNode=n(parentNode.link[r]);if(findedNode){break;}}}}if(a==""){a=TRIE_TERMINAL_ENTRY;}else{a=a;}return a;}function n(s){var r;if(s.link==undefined){return false;}node=s;while(node.end==0||node==s){r=c(node);a+=k[r];node=node.link[r];}if(a==""){return false;}return node;}function c(s){var r=-1;for(i=0;i<g;i++){if(s.link[i]!=undefined){r=i;break;}}return r;}function l(t,s){a="";var r=-1;for(i=s+1;i<g;i++){if(t.link[i]!=undefined){r=i;a+=k[r];break;}}return r;}function o(s){var r=d;for(i=0;i<s.length;i++){r=r.link[h[s.charCodeAt(i)]];}return r;}function f(s){var r=o(s);j=s.length-1;if(r.children>0){r.end=0;}else{while(r.parentNode!=undefined){r=r.parentNode;r.link[h[s.charCodeAt(j)]]=null;delete r.link[h[s.charCodeAt(j)]];r.children--;j--;if(r.children>0){console.log("break!");break;}}}}var m={add:p,deleteUsername:f,mapChars:q,rootNode:d};return m;})();