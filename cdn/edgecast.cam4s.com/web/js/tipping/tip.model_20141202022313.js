var TipDeltas={sendTipSampling:10,performer:{GHS_delta:1000,GHS_init:10000,GLT_init:5000,CS_tryAgain:2000,failureSampling:5,incrementAfterFailure:1000,watchDog:{restartAfter:20000,waitBeforeRestart:200,killPendingAt:20}},viewer:{getViewS_delta:1000,sessionGotFailureSampling:10,getViewS_init:1000,getLastTS_init:8000,getViewS_incrementOnFail:1000,getViewS_restoreFromFail:8000,getLastTS_incrementOnFail:1000},allowWatchDogDebug:function(){return(Math.round(Math.random()*100)===50);}};var ServiceWebSocket={delimiter:"@",connect:function(){},send:function(a){console.log("unimplemented yet, sending "+a);},onMessage:function(a){}};Array.prototype.allValuesSame=function(){if(this.length>0){for(var a=1;a<this.length;a++){if(this[a]!==this[0]){return false;}}}return true;};var Cam4Logs=Cam4Logs?Cam4Logs:{};Cam4Logs.logs=Cam4Logs.logs?Cam4Logs.logs:"";Cam4Logs.debug=Cam4Logs.debug?Cam4Logs.debug:function(a){Cam4Logs.logs+="edgecast did not load Cam4Utils.js "+a;};Cam4Logs.stringify=Cam4Logs.stringify?Cam4Logs.stringify:function(a){return a+"";};Cam4Logs.print=Cam4Logs.print?Cam4Logs.print:function(a){Cam4Logs.logs+="js hosting server did not load Cam4Utils.js "+a;};var TipSampler=function(){var a=new Array();var c=new Array();var b=TipDeltas.sendTipSampling;this.push=function(d){if(d>c[c.length-1]){var e=d-c[c.length-1];e=(e+"").charAt(0);e=parseInt(e);a.push(e);}c.push(d);return c;};this.allow=function(){var d=new Array();for(var e=a.length-1;e>a.length-b;e--){d.push(a[e]);}return !d.allValuesSame();};this.flush=function(){a=new Array();c=new Array();for(var d=0;d<b+1;d++){a.push(1);}a.push(new Date());};this.flush();};Array.min=function(a){return Math.min.apply(Math,a);};Array.max=function(a){return Math.max.apply(Math,a);};var TipCommunicator=new function(){var g=new TipSampler();var h="http://"+TIPPING_SERVER;var c=h+"/tipper/tipping.user.php";var e=h+"/tipper/tipping.class.php";this.getDomain=function(){if(window.location&&window.location.host){return window.location.host;}else{window.location={};window.location.host=document.URL.match(/:\/\/(.[^/]+)/)[1];}return window.location.host;};this.getURL=function(){return h;};this.breakURL=function(){c="http://localhost/SheicProj/SheicPhp/tipping/tipper/tipping.user.php";e="http://localhost/SheicProj/SheicPhp/tipping/tipper/tipping.user.php";};this.restoreURL=function(){h="http://"+TIPPING_SERVER;c=h+"/tipper/tipping.user.php";e=h+"/tipper/tipping.class.php";};Cam4Logs.debug("TipCommunicator created with TIPPING_SERVER "+TIPPING_SERVER);var i=this;var d={performerName:"undefined",viewerName:"undefined",webCdn:WEB_CDN?WEB_CDN:"",lang:Cam4User.lang?Cam4User.lang:"en",kN:0,iB:0};d.performerName=Cam4User.performerName;d.viewerName=Cam4User.userName;d.kN=Cam4User.kN;d.iB=Cam4User.iB;d.lang=Cam4User.lang;this.status={callsToGetUserSession:{total:0,times:[]},callsToGetLastTips:{total:0,times:[]},callsToGetHostSession:{total:0,times:[]},callsToCreateSession:{total:0,times:[]},callsToGetBalance:{total:0,times:[]}};this.getStatus=function(){function l(p){var n=new Object();var m=new Array();if(p.length>1){for(var o=1;o<p.length;o++){m.push(p[o]-p[o-1]);}n.maxDelay=Array.max(m);n.minDelay=Array.min(m);n.lastDelay=p[p.length-1].getTime()-p[p.length-2].getTime();}return n;}for(var k in this.status){this.status[k].rate=l(this.status[k].times);}return this.status;};this.destroy=function(){this.getUserSession=function(){};this.getLastTips=function(){};this.getHostSession=function(){};};this.setData=function(m,k,l,o,n){d.performerName=m;d.viewerName=k;d.kN=l;d.iB=o;if(n){d.lang=n;}};this.removeScript=function(k){setTimeout(function(){try{k.root.removeChild(k.script);}catch(l){Cam4Logs.debug("TC: unable to remove script because "+Cam4Logs.stringify(l));}},200);};this.random=function(){return Math.random();};var j=false;var f=new Date("1985");this.getUserSession=function(n,r){var q='{"operation":"getUserSession","session_id":"'+n+'","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var m=c+"?callback="+r+"&params="+q+"&zzz="+this.random();var o=ServiceTipViewer.getIntervals().getSessionIn;var l=new Date();var p=l.getTime()-f.getTime();if(p<o){Cam4Logs.print("TC: you are trying to make a call to getUserSession in "+p+"ms rather than in "+o+" miliseconds");}f=l;if(Cam4User.isLoggedIn){this.status.callsToGetUserSession.total++;this.status.callsToGetUserSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.print("TC: getUserSession script: "+s);i.removeScript(k);},true);}else{if(!Cam4User.isLoggedIn&&!j){this.status.callsToGetUserSession.total++;this.status.callsToGetUserSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.print("TC: getUserSession script: "+s);i.removeScript(k);},true);j=!Cam4User.useFirebase();}}return Cam4User.isLoggedIn;};this.sendTipAmmount=function(n,q,p){g.push(new Date());var l=q;l=parseInt(l);if(g.allow()){var o='{"operation":"sendTip","session_id":"'+n+'","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","amount":"'+l+'","message":"","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"';if(typeof Cam4User.stealthModeValue!="undefined"&&Cam4User.stealthModeValue!=""){o+=', "i": "'+Cam4User.stealthModeValue+'"';}o+="}";var m=c+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(m,function(r){Cam4Logs.print("TC: sendTip script: "+r);i.removeScript(k);},true);}else{Cam4Logs.debug("you are sending tips at same interval of time. Are you a human person?");g.flush();}};var b=new Date("1985");this.getLastTips=function(n,p,l){var o='{"operation":"getLastTipsJ","session_id":"'+n+'","model_id":"'+d.performerName+'","last_id":"'+p+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var k="";if(Cam4User.userName==Cam4User.performerName){k=e+"?callback="+l+"&params="+o+"&zzz="+this.random();}else{k=c+"?callback="+l+"&params="+o+"&zzz="+this.random();}var q=ServiceTipViewer.getIntervals().getSessionIn;if(Cam4User.userName==Cam4User.performerName){q=ServiceTipPerformer.getIntervals().lastTipsIn;}var m=new Date();var r=m-b;if(r<q){}b=m;if(Cam4User.isLoggedIn){this.status.callsToGetLastTips.total++;this.status.callsToGetLastTips.times.push(new Date());var s=Utils.injectJavascript(k,function(t){Cam4Logs.print("TC: getLastTips script: "+t);i.removeScript(s);},true);}};var a=new Date("1985");this.getHostSession=function(o,r){var q='{"operation":"getHostSession","session_id":"'+o+'","model_id":"'+d.performerName+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var m=e+"?callback="+r+"&params="+q+"&zzz="+this.random();var n=ServiceTipPerformer.getIntervals().hostHessionIn;var l=new Date();var p=l.getTime()-a.getTime();if(p<=n){}a=l;if(Cam4User.isLoggedIn){this.status.callsToGetHostSession.total++;this.status.callsToGetHostSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.print("TC: getHostSession script: "+s);i.removeScript(k);},true);}};this.setGoal=function(n,m,p){var o='{"operation":"setGoal","session_id":"'+n+'","model_id":"'+d.performerName+'","amount":"'+m+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.print("TC: setGoal script: "+q);i.removeScript(k);},true);};this.setMessage=function(m,n,p){var o='{"operation":"setMessage","session_id":"'+m+'","model_id":"'+d.performerName+'","message":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain":"'+this.getDomain()+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.print("TC: setMessage script: "+q);i.removeScript(k);},true);};this.setTimeLimit=function(m,n,p){var o='{"operation":"setTimeLimit","session_id":"'+m+'","model_id":"'+d.performerName+'","deadline":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.print("TC: setTimeLimit script: "+q);i.removeScript(k);},true);};this.createSession=function(n){var m='{"operation":"createSession","model_id":"'+d.performerName+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain":"'+this.getDomain()+'"}';var l=e+"?callback="+n+"&params="+m+"&zzz="+this.random();if(Cam4User.isLoggedIn){this.status.callsToCreateSession.total++;this.status.callsToCreateSession.times.push(new Date());var k=Utils.injectJavascript(l,function(o){Cam4Logs.print("TC: createSession script: "+o);i.removeScript(k);},true);}};this.getBalance=function(n){var m='{"operation":"getBalance","user_id":"'+d.viewerName+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var l=c+"?callback="+n+"&params="+m+"&zzz="+this.random();this.status.callsToGetBalance.total++;this.status.callsToGetBalance.times.push(new Date());var k=Utils.injectJavascript(l,function(o){Cam4Logs.print("TC: getBalance script: "+o);i.removeScript(k);},true);};this.sendOfflineTip=function(m,n,p){var o='{"operation":"sendOfflineTip","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","amount":"'+m+'","message":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'", "domain": "'+this.getDomain()+'"}';var l=c+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.print("TC: sendOfflineTip status: "+q);i.removeScript(k);},true);};this.getData=function(){return d;};this.killPending=function(){try{window.stop();}catch(l){Cam4Logs.debug("window.stop failed with "+Cam4Logs.stringify(l));try{window.document.execCommand("Stop");}catch(k){Cam4Logs.debug("window.document.execCommand failed with "+Cam4Logs.stringify(k));try{document.execCommand("Stop");}catch(k){Cam4Logs.debug("document.execCommand failed with "+Cam4Logs.stringify(k)+" pendings are still alive");}}}};this.getLogs=function(){return{};};};var ServiceTipPerformer=new function(){var r=TipCommunicator;var a="";var g="";var u=this;Cam4Logs.debug("ServiceTipPerformer instance created");this.getMethod=function(J){return"ServiceTipPerformer."+J;};var C=new Array();var B=new Array();var m=new Array();var q=new Array();var y=new Array();var I=new Array();var d=new Array();var b=false;var f=false;var A="";var F="";var z=TipDeltas.performer.GHS_init;var E=TipDeltas.performer.GLT_init;var x="";this.getIntervals=function(){return{hostHessionIn:z,lastTipsIn:E};};function H(M,L){for(var K=0;K<M.length;K++){try{M[K](L);}catch(J){Cam4Logs.debug("CALLBACK ERROR: "+Cam4Logs.stringify(J)+J);}}}var c=0;var p=TipDeltas.performer.CS_tryAgain;var l="";function k(){c++;clearTimeout(l);clearTimeout(A);clearTimeout(F);if(c>TipDeltas.performer.failureSampling){p+=TipDeltas.performer.incrementAfterFailure;Cam4Logs.debug("more than 5 errors when trying to create session, down to ..."+p);}l=setTimeout(function(){v();},p);}function v(){Cam4Logs.debug("ServiceTipPerformer createSession:");clearTimeout(l);clearTimeout(A);clearTimeout(F);r.createSession(u.getMethod("sessionCreated"));}this.sessionCreated=function(J){Cam4Logs.debug("performer session created: "+Cam4Logs.stringify(J));if(J){if(J.session_id){if(J.status){if(J.status>=0){a=J.session_id;H(m,J);G();t();f=true;p=TipDeltas.performer.CS_tryAgain;}else{if(J.status==-2){Cam4Logs.debug("status -2, you should refresh browser");k();}else{if(J.status==-1){Cam4Logs.debug("status =  "+J.status+" try Again Creating Session");p=TipDeltas.performer.CS_tryAgain;k();}}}}else{Cam4Logs.debug("s- session created no status");k();}}else{Cam4Logs.debug("s- no session_id generated");k();}}else{Cam4Logs.debug("die, no args you should refresh browser");k();}};function G(){clearTimeout(A);if(b){r.getHostSession(a,u.getMethod("hostSessionGot"));}else{Cam4Logs.debug("ServiceTipPerformer not started yet");}}this.FireBaseUpdated=function(){if(Cam4User.useFirebase()===false){G();}};this.getSessionOnce=function(){if(Cam4User.useFirebase()){Cam4Logs.debug("public ServiceTipPerformer.getSessionOnce... ");r.getHostSession(a,u.getMethod("sessionOnceGot"));r.getLastTips(a,g,u.getMethod("lastTipsOnceGot"));return true;}return false;};this.sessionOnceGot=function(J){Cam4Logs.debug("sessionOnceGot with "+Cam4Logs.stringify(J));var L={};for(var K in J){if(K!=="f"&&K!=="session_id"){L[K]=J[K];}}H(C,L);};this.getTipsOnce=function(){r.getLastTips(a,g,u.getMethod("lastTipsOnceGot"));};this.lastTipsOnceGot=function(J){Cam4Logs.debug("lastTipsOnceGot with "+Cam4Logs.stringify(J));var L={};for(var K in J){L[K]=J[K];}if(J.last_id){g=J.last_id;}H(B,L);};var n=0;var o={total:0,goal:0,topTipper:"undefined",topTipperAmount:"undefined",lastTipper:"undefined",lastTipperAmount:"undefined"};var j=false;var D=-999;this.hostSessionGot=function(J){clearTimeout(A);if(J){Cam4Logs.debug("host session got with "+Cam4Logs.stringify(J));if(J.session_id){a=J.session_id;if(J.status){n=0;if(J.f){z=(parseInt(J.f)*TipDeltas.performer.GHS_delta);}if(J.status==-1){Cam4Logs.debug("hostSessionGot status -1, try again create session");k();return;}else{if(J.status==-2){Cam4Logs.debug("hostSessionGot status -2, try again create session");k();return;}else{if(J.status>=0){p=30000;var L={};for(var K in J){if(K!=="f"&&K!=="session_id"){L[K]=J[K];}}if(J.goal){o.goal=J.goal;}if(J.goalbalance){o.total=J.goalbalance;}if(J.toptipper){o.topTipper=J.toptipper;}if(J.tlamount){o.topTipperAmount=J.tlamount;}if(J.last_id){j=true;clearTimeout(F);s=false;if(J.last_id>D){Cam4Logs.debug("last_id incremented: "+J.last_id+">"+D+" getLastTips for "+g);t();D=J.last_id;}}H(C,L);if(b&&Cam4User.useFirebase()===false){A=setTimeout(G,z);}if(b&&Cam4User.useFirebase()===true){A=setTimeout(G,49000);}}else{Cam4Logs.debug("hostSessionGot status is not numeric, try again create session");k();return;}}}}else{Cam4Logs.debug("hostSessionGot found no status, try again create session");k();}}else{n++;if(n===1){console.log("no session_id given, try once getHostSession");if(b){A=setTimeout(G,z);}}else{Cam4Logs.debug("no session_id given, try once createSession");k();}}}else{Cam4Logs.debug("s- hostSessionGot NO RESPONSE REFRESH BROWSER");k();}};var i="";function t(){clearTimeout(F);if(u.hasSession()&&b){r.getLastTips(a,g,u.getMethod("lastTipsGot"));}else{if(b){i=setTimeout(t,1000);}else{clearTimeout(i);}}}var s=true;this.lastTipsGot=function(J){Cam4Logs.debug("lastTipsGot with "+Cam4Logs.stringify(J));clearTimeout(F);if(J){if(J.last_id){g=J.last_id;}var N={};for(var M in J){N[M]=J[M];}if(J.tips&&J.tips.length>0){try{o.lastTipper=J.tips[0].user;o.lastTipperAmount=J.tips[0].amount;}catch(L){}}H(B,N);if(b&&this.hasSession()&&s&&Cam4User.useFirebase()===false){F=setTimeout(t,E);}var K="L";K+=o.total+ServiceWebSocket.delimiter;K+=o.goal+ServiceWebSocket.delimiter;K+=o.topTipper+ServiceWebSocket.delimiter;K+=o.topTipperAmount+ServiceWebSocket.delimiter;K+=o.lastTipper+ServiceWebSocket.delimiter;K+=o.lastTipperAmount;if(j){ServiceWebSocket.send(K);}o.lastTipper="undefined";o.lastTipperAmount="undefined";o.topTipper="undefined";o.topTipperAmount="undefined";}else{Cam4Logs.debug("lastTipsGot called without arguments, looping stopped");clearTimeout(F);}};this.lastTimeLimit="";this.setTimeLimit=function(J){this.lastTimeLimit=J;r.setTimeLimit(a,J,this.getMethod("timeLimitSet"));};this.lastMessageSet="";this.setMessage=function(J){this.lastMessageSet=J;r.setMessage(a,J,this.getMethod("messageSet"));};this.lastGoal="";this.setGoal=function(J){this.lastGoal=J;r.setGoal(a,J,this.getMethod("goalSetted"));};this.messageSet=function(J){Cam4Logs.debug("messageSet: "+Cam4Logs.stringify(J));if(J){if(J.badword){if(Cam4User.userId){JsReceiver.statusMessageCensoredWord(Cam4User.userId,J.badword);}}if(J.status){if(J.status>=0){ServiceWebSocket.send("M"+this.lastMessageSet);H(d,J);}}}};this.timeLimitSet=function(J){Cam4Logs.debug("timeLimitSet: "+Cam4Logs.stringify(J));if(J){if(J.status){if(J.status>=0){ServiceWebSocket.send("T"+this.lastTimeLimit);H(I,J);}}}};this.goalSetted=function(J){Cam4Logs.debug("goalSet: "+Cam4Logs.stringify(J));if(J){if(J.status){if(J.status>=0){ServiceWebSocket.send("G"+this.lastGoal);H(y,J);}}}};this.start=function(){if(!b&&Cam4User.isLoggedIn){b=true;clearTimeout(A);clearTimeout(F);clearInterval(x);clearTimeout(i);p=TipDeltas.performer.CS_tryAgain;if(!this.hasSession()){Cam4Logs.debug("ServiceTipPerformer started with create session");v();}else{Cam4Logs.debug("ServiceTipPerformer started with get host session");G();t();}w=0;if(Cam4User.useFirebase()===false){x=setInterval(h,100);}}return b;};this.stop=function(){b=false;clearTimeout(A);clearTimeout(F);clearInterval(x);clearTimeout(i);w=0;Cam4Logs.debug("ServiceTipPerformer stopped="+!b);};var e=TipDeltas.performer.watchDog.restartAfter;var w=0;function h(){if(TipCommunicator.getStatus().callsToGetHostSession.times.length>0){var M=new Date();var K=TipCommunicator.getStatus().callsToGetHostSession.times[TipCommunicator.getStatus().callsToGetHostSession.times.length-1];var L=M.getTime()-K.getTime();if(L>e){w++;if(w>(TipDeltas.performer.watchDog.killPendingAt/2)&&w<TipDeltas.performer.watchDog.killPendingAt){TipCommunicator.killPending();Cam4Logs.debug("kill pending scripts... "+w);}if(w>TipDeltas.performer.watchDog.waitBeforeRestart){u.stop();try{ReportSender.onTippingFailed();}catch(J){}u.start();w=0;}if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("wait "+w+"/"+TipDeltas.performer.watchDog.waitBeforeRestart);}}else{if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("watchdog is running, timeFromLastCall = "+L+" from max of "+e);}}}else{if(!u.hasSession()){w++;if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("watchdog found no session at "+new Date()+"  wait "+w+" / "+TipDeltas.performer.watchDog.waitBeforeRestart);}if(w>TipDeltas.performer.watchDog.waitBeforeRestart){u.stop();try{ReportSender.onTippingFailed();}catch(J){}u.start();w=0;}}}}this.onTimeLimitSet=function(J){I.push(J);};this.onMessageSet=function(J){d.push(J);};this.onGoalSetted=function(J){y.push(J);};this.onSessionCreated=function(J){m.push(J);};this.onHostSessionGot=function(J){C.push(J);};this.onLastTipsGot=function(J){B.push(J);};this.onError=function(J){q.push(J);};this.hasSession=function(){return(typeof a!="undefined")&&(a!=="");};this.getSessionId=function(){return a;};this.isRunning=function(){return b;};this.removeEventListeners=function(){C=new Array();B=new Array();m=new Array();q=new Array();y=new Array();I=new Array();d=new Array();return true;};};var ServiceTipViewer=new function(){var r=TipCommunicator;Cam4Logs.debug("ServiceTipViewer instance created");var a="";var h="";var t=this;var k=new Array();var v=new Array();var u=new Array();var p=new Array();var j="";var n=0;var g=0;var o="";var q=TipDeltas.viewer.getViewS_init;var e="";var f=TipDeltas.viewer.getLastTS_init;this.getIntervals=function(){return{getUserSession:q,getLastTips:f};};this.getIntervals=function(){return{getSessionIn:q,lastTipsIn:f};};var b=false;var x=true;var m=true;function B(E,D){for(var C=0;C<E.length;C++){E[C](D);}}var A=0;function l(C){Cam4Logs.debug("check status"+C);if(C>=0){A=0;}else{if(C==-1){B(p,{message:"no tokens in balance",description:"no_more_tokens"});}else{if(C==-2){A++;q=q+TipDeltas.viewer.getViewS_incrementOnFail;f=f+TipDeltas.viewer.getLastTS_incrementOnFail;console.log(q+" downing to..."+f);B(p,{message:nstiplang.errors.serverConnectionError,description:"err_auth_failed"});if(A>10){Cam4Logs.debug(" fatalErrors > 10, closing calls");r.destroy();t.stop();}}}}}var d={userbalance:"",message:"",goal:"0",goalbalance:"0",deadline:"",crtbalance:0,tlamount:0,toptipper:"",status:""};var z={response:"",tippers:[],status:""};var i="undefined";this.start=function(){if(Cam4User.useFirebase()===false){if(!b&&Cam4User.isLoggedIn){this.stop();b=true;m=true;x=true;w();s();}else{if(!b&&!Cam4User.isLoggedIn){this.getSessionOnce();b=true;}}}};this.getMethod=function(C){return"ServiceTipViewer."+C;};this.sendTip=function(C){r.sendTipAmmount(a,C,this.getMethod("tipSent"));};this.tipSent=function(C){if(C){if(C.status){l(C.status);}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_status_tipSent"});}}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_response_tipSent"});}i.tipSentArgs=C;B(u,C);try{Cam4Event.dispatch(TipEvent.ON_TIP_SENT,C);}catch(D){}};function s(){if(a!==""){g++;Cam4Logs.debug("totalCallsToLastTips = "+g);var C=Cam4User.useFirebase();if(!C){C=b;}if(C){r.getLastTips(a,h,t.getMethod("lastTipsGot"));}else{g--;}return true;}else{if(b&&m&&Cam4User.useFirebase()===false){e=setTimeout(s,f);}}return false;}this.lastTipsGot=function(C){console.log("last tips got",C);z.tippers=new Array();if(C){if(C.status){l(C.status);}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_status_lastTipGot"});}if(C.last_id&&C.last_id!==""){h=C.last_id;}if(C.response){z.response=C.response;}if(C.tips){z.tippers=C.tips;}if(C.status){z.status=C.status;}}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_response_lastTipsGot"});}if(b&&m&&Cam4User.isLoggedIn&&Cam4User.useFirebase()===false){Cam4Logs.debug("next call to getLastTips in "+f+" seconds");e=setTimeout(s,f);}i.lastTipsReponseForViewer=z;B(v,z);};function w(){if(b){n++;r.getUserSession(a,t.getMethod("sessionGot"));Cam4Logs.debug("totalCallsToSession = "+n);}}this.FireBaseUpdated=function(){if(Cam4User.useFirebase()===false){w();}};this.getSessionOnce=function(){n++;console.log("session: "+a);r.getUserSession(a,t.getMethod("sessionGotOnce"));return true;};this.sessionGotOnce=function(C){console.log("session got once",C);try{Cam4Event.dispatch("viewer_session_got",C);}catch(E){}if(C){if(C.session_id){a=C.session_id;}if(C.last_id){if(C.last_id>y){Cam4Logs.debug("last_id received on sessionGotOnce: "+C.last_id+" kill looping");y=C.last_id;s();}}for(var D in C){if(D!=="session_id"&&D!=="f"&&C[D]!==null){d[D]=C[D];}}B(k,d);i.sessionResponseForViewer=d;}};var c=0;var y=-999;this.sessionGot=function(C){if(C){if(C.session_id){a=C.session_id;}else{c++;Cam4Logs.debug("session_id failed "+c);if(c>TipDeltas.viewer.sessionGotFailureSampling){q+=TipDeltas.viewer.getViewS_incrementOnFail;}Cam4Logs.debug("missing session id from server in sessionGot");B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_id_sessionGot"});if(a>0){this.clearSession();}}if(C.status){if(C.status==-2){console.log("Viewer DIE, REFRESH BROWSER");B(p,{message:nstiplang.errors.serverConnectionError,description:"err_auth_failed_sessionGot"});return;}}if(C.last_id){clearTimeout(e);m=false;if(C.last_id>y){Cam4Logs.debug("last_id received: "+C.last_id+" kill looping");y=C.last_id;s();}}if(C.f){if(parseFloat(C.f)!==parseFloat(q)){q=parseFloat(C.f)*TipDeltas.viewer.getViewS_delta;}}if(C.userbalance&&parseInt(C.userbalance)>=0){j=C.userbalance;}for(var D in C){if(D!=="session_id"&&D!=="f"&&C[D]!==null){d[D]=C[D];}}}else{q=TipDeltas.viewer.getViewS_restoreFromFail;Cam4Logs.debug("missing response from server in sessionGot");B(p,{message:nstiplang.errors.serverConnectionError,description:"err_no_response_sessionGot"});}B(k,d);i.sessionResponseForViewer=d;if(b&&x&&Cam4User.isLoggedIn&&Cam4User.useFirebase()===false){Cam4Logs.debug("NO VERSIONING : next call to getViewerSession in "+q+" seconds");o=setTimeout(w,q);}else{this.stop();}};this.stop=function(C){if(!b){console.log("service viewer already stopped");}else{console.log("stopping service viewer");}if(C){switch(C){case"getSession":clearTimeout(o);x=false;return;break;case"getLastTips":clearTimeout(e);m=false;break;}}else{clearTimeout(o);clearTimeout(e);x=false;m=false;}b=false;};this.removeEvent=function(D,C){switch(D){case"onSessionGot":if(C){k.slice(C,1);}else{k=new Array();}break;case"onLastTipsGot":v.slice(C,1);break;case"onTipSent":u.slice(C,1);break;case"onError":p.slice(C,1);break;}};this.removeEventListeners=function(){k=new Array();v=new Array();u=new Array();p=new Array();return true;};this.onSessionGot=function(C){if(C){k.push(C);return k.length;}else{return{remove:function(D){k.slice(D,1);}};}};this.clearSession=function(){a="";};this.onLastTipsGot=function(C){v.push(C);};this.onTipSent=function(C){u.push(C);};this.onError=function(C){p.push(C);};this.getCommunicator=function(){return r;};this.hasSession=function(){return(typeof a!="undefined"&&a!==""&&a!="null"&&a!="undefined");};this.hasBalance=function(){return j!=="";};this.getSomeRespone=function(){return i;};this.getSessionId=function(){return a;};this.isRunning=function(){return b;};};var TipFactory={balanceCookieName:"cam4-tipGetBalanceAction",popHelp:function(){if(Cam4User.useResponsiveLayout){Utils.closeModalPops();$(".modal-content").empty();$("#modalLayout").modal({remote:"/help/tipping/what?type=modal"});}else{window.open("/help/tipping/what","","width=700,height=600,scrollbars=1,toolbars=0,status=0");}},getTippingLogs:function(e,a){var d=unescape(Cam4Cookies.getCookie(TipFactory.balanceCookieName));var b=Cam4User.userName+"|";b+=ErrorLogger.settings.currentIp+"|";b+=Cam4User.lang+"|";try{b+=document.URL.replace("http://","").split("/")[0]+"|";}catch(c){}b+=BrowserDetect.browser+"|";b+=BrowserDetect.version+"|";b+=BrowserDetect.OS+"| \n";b+="GET BALANCE ACTION: "+d+"\n";b+="CAM4 DEBUGS: \n";b+=Cam4Logs.debugs;b+="TIP COMMUNICATOR STATUS: "+Cam4Logs.stringify(TipCommunicator.getStatus())+"\n";if(e==="all"){return b;}if(a>0){return b.substr(e,a);}if(b.length>25000){return b.substr(0,25000)+" <...>";}return b;},getSessionId:function(){if(Cam4User.isBroadcaster()){return ServiceTipPerformer.getSessionId();}else{return ServiceTipViewer.getSessionId();}},popTokens:function(){if(Cam4User.useResponsiveLayout){if(document.getElementById("NSViewerOverlay")){document.getElementById("NSViewerOverlay").style.display="none";}Utils.popWithAjaxContent("/checkout/tokens?type=modal");return;}var a=window.open("/checkout/tokens","tipWindow","width=650, height=880,scrollbars=1,toolbars=0,status=0");setTimeout(function(){if(!a||a.closed||!a.document){Utils.safePopUp("/checkout/tokens",popUpCheckoutWidth,700);}else{a.focus();}},100);},camelize:function(a){return a.replace(/(?:^\w|[A-Z]|\b\w)/g,function(c,b){return c.toUpperCase();}).replace(/\s+/g,"");},parseKey:function(b){if(b.indexOf(" ")>-1){var a=TipFactory.camelize(b);if(nstiplang.serverMessages[a]){return nstiplang.serverMessages[a];}return b;}if(nstiplang.serverMessages[b]){return nstiplang.serverMessages[b];}return b;},redirectGuest:function(){var a="/gold?ct=wost&contextual=tokens-"+Cam4User.contextualGender+"&sendtipuser="+Cam4User.performerName;if(Cam4User.useResponsiveLayout){a+="&type=modal";Utils.popWithAjaxContent(a);}else{window.location=a;}}};var TipEvent={ON_BALANCE_GOT:"tipping_balance_got",ON_TIP_SENT:"on_tip_sent"};